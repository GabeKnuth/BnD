#config_version=4
mode:
  priority: 500
  start_events: start_world_tour_mode

# todo
#when over, has to start something else. Doc says another mode.
#lights
#scoring
# need to redo this so it goes in sequence. Needs shot groups?

event_player:
  mode_world_tour_started:
    mode_running|10s
  player_world_tour_world_tour_timer_tick{value == 5}:
    slow_down_timer

# We need to set up shots so that we start on the North America shot, then move on to
# Europe, then South America, and finally Australia

shots:
  shot_australia:
    switch: s_TopRightVUK
    delay_switch:
      s_spinner: 2s
    show_tokens:
      led: l_australia
  shot_europe:
    switch_sequence: s_spinner, s_TopRightVUK
    time: 2s
    show_tokens:
      led: l_europe
  shot_north_america:
    switch: s_leftorbit
    advance_events: mode_world_tour_started # Needs to start on this shot
    show_tokens:
      led: l_north_america
  shot_south_america:
    switch: s_rightrampopto
    show_tokens:
      led: l_south_america

shot_groups:
    world_tour_shots:
        shots: shot_north_america, shot_europe, shot_south_america, shot_australia
        profile: wt_advertise
        enable_events: mode_world_tour_started
        disable_events: all_shots_made
        rotate_right_events: shot_group_world_tour_shots_flashing_hit
        #debug: true

shot_profiles:
    wt_advertise:
      states:
        - name: unlit
          show: off
        - name: flashing
#          show: flash_color
          show: flash
          speed: 10
      loop: yes
      advance_on_hit: yes

ball_locks:
  wt_intro_lock:
    balls_to_lock: 1
    lock_devices: bd_lower_vuk
    enable_events: mode_world_tour_started
    request_new_balls_to_pf: False
    release_one_events: timer_wt_intro_timer_complete


# Mode timer so we know when time runs out. We'll count down at 1s intervals, then change to 1.25
# for the last five seconds. It wasn't in the rules doc, but I also added a pause if the ball goes
# into the subway. It resumes when the ball is kicked out of the lower VUK.

#timers:
#    __valid_in__: mode
#    debug: single|bool|False
#    start_value: single|int|0
#    end_value: single|int|None
#    direction: single|str|up
#    max_value: single|ms|None
#    tick_interval: single|ms|1s
#    start_running: single|bool|False
#    control_events: list|subconfig(control_events)|None
#    restart_on_complete: single|bool|False
#    bcp: single|bool|False

timers:
    world_tour_timer:
        start_value: 20
        max_value: 20
        tick_interval: 1.25s
        direction: down
        control_events:
          - event: timer_wt_intro_timer_complete
            action: start
          - event: slow_down_timer #player_world_tour_world_tour_timer_tick{value == 5}
            action: change_tick_interval
            value: 1.5
          - event: add_time
            action: add
            value: 3
          - event: s_subwayopto_active
            action: stop
          - event: balldevice_bd_lower_vuk_ball_left
            action: start
    wt_intro_timer:
        start_value: 3
        direction: down
        control_events:
          - event: mode_world_tour_started
            action: start

# We need a show for each shot. There are four shots, so four shows. Each show will do a light
# sweep (one up-down, one down-up, one left-right, one right-left) and play a video of a plane
# flying across the earth.
#
# Each shot has a specific video. When the player hits the Australia shot, it plays the
# wt_australia video, etc...

show_player:
  shot_south_america_hit:
    south_america:
      loops: 0
  shot_australia_hit:
    australia:
      loops: 0
  shot_europe_hit:
    europe:
      loops: 0
  shot_north_america_hit:
    north_america:
      loops: 0

# We also have a video bed for this mode, so we have to figure out a way to play that video bed
# first, then play the plane animations over that, returning to the video when they're done. Let's
# try putting that on a slide, then playing shows over it.

slides:
  intro_dmd:
    widgets:
      - type: text
        text: Hit flashing shots
        anchor_y: top
        style: dmd_small
        y: top-1
        anchor_x: right
        x: right-1
      - type: text
        text: to complete the
        style: dmd_small
        anchor_y: bottom
        y: center
        anchor_x: right
        x: right-1
      - type: text
        text: WORLD TOUR!
        style: dmd_big
        anchor_y: bottom
        y: bottom+1
        anchor_x: right
        x: right-1
      - type: video
        video: wt_spinny_globe_dmd
        end_behavior: loop
        anchor_x: left
        x: left
    target: dmd
  world_tour_stage:
    widgets:
      - type: video
        video: wt_boot_scoot
        end_behavior: loop
  world_tour_dmd:
    widgets:
      - type: video
        video: wt_spinny_globe_dmd
        end_behavior: loop
        anchor_x: left
        x: left
      - type: text
        text: Time left (world_tour_world_tour_timer_tick)
        anchor_y: bottom
        style: dmd_small
        y: bottom+1
        anchor_x: right
        x: right-1
      - type: text
        text: (player1|score)
        number_grouping: true
        min_digits: 2
        anchor_x: right
        x: right-1
        y: middle
        style: tall title
      - type: text
        text: Each hit = 100k
        anchor_y: top
        style: dmd_small
        y: top-1
        anchor_x: right
        x: right-1

slide_player:
  mode_world_tour_starting:
    intro_dmd:
      target: dmd
    world_tour_stage:
      target: stage
  mode_running:
    world_tour_dmd:
      target: dmd

# Now we need a logic block to keep track of shots. When all four are hit, we're done!
# It's not in the rules, but I also added something to extend the time when you hit a shot
# just so that the song plays longer.

# Might not need the sequence
logic_blocks:
    sequences:
        world_tour_sequence:
            events:
              - shot_north_america_hit
              - shot_europe_hit
              - shot_south_america_hit
              - shot_australia_hit
            enable_events: mode_world_tour_started
            events_when_complete: all_shots_made
            persist_state: true
    counters:
        stop_adding_time:
            count_events: shot_north_america_hit, shot_europe_hit, shot_south_america_hit, shot_australia_hit
            events_when_hit: add_time
            count_complete_value: 3
            events_when_complete: world_tour_stop_adding_time
            enable_events: mode_world_tour_started
            disable_events: logicblock_stop_adding_time_complete
            multiple_hit_window: 500ms
            persist_state: true


